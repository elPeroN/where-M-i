<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://vjs.zencdn.net/7.5.5/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.js"></script>
    <script src='https://vjs.zencdn.net/7.5.5/video.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.5.5/video-js.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/videojs-record/3.8.0/css/videojs.record.min.css" rel="stylesheet">

    <script src="https://cdn.WebRTC-Experiment.com/RecordRTC.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.5.5/video.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.1.1/adapter.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-record/3.8.0/videojs.record.js"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <!-- Google -->

    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="588726918570-3tfcmo8nh5al0mupr29rsjmlop8jm9ce.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
    <script src="https://apis.google.com/js/api:client.js"></script>


</head>
<body>

    <label for="title">Title</label>
    <input type="text" id="title"><br><br>

    <label for="latitudine">Latitude</label>
    <input type="text" id="latitudine"><br><br>

    <label for="longitudine">Longitude</label>
    <input type="text" id="longitudine"><br><br>
    
    <label for="purpose">Purpose</label>
    <input type="text" id="purpose"><br><br>

    <label for="language">Language</label>
    <input type="text" id="language"><br><br>

    <label for="content">Content</label>
    <input type="text" id="content"><br><br>

    <label for="audience">Audience</label>
    <input type="text" id="audience"><br><br>

    <label for="detail">Detail</label>
    <input type="text" id="detail">
    <br><br><br>

    <input type="text" id="inputProva">
    <input type="text" id=start value="start">
    <input type="text" id="end" value="end">
    <input type="text" id="volume" value="volume">

    <button  onclick="trim()">Trim</button>
    <button onclick="startRec()">Start</button>
    <button onclick="stopRec()">Stop</button>
    <button onclick="saveRec()">Save</button>
    <video id="myVideo" playsinline class="video-js vjs-default-skin"></video>
    <audio id="myAudio" class="video-js vjs-default-skin"></audio>
    <div class="g-signin2" data-onsuccess="onSignIn" data-theme=""></div>
<script>

function init() {
    gapi.load('client:auth2', function () {
        gapi.auth2.init();
    });
}
function ifNotSignIn() {
    var auth2 = gapi.auth2.getAuthInstance();
    if (auth2.isSignedIn.get() === false){
        //document.location.href = 'https://site181903.tw.cs.unibo.it/login';
    }
}   
// Inizializzazione YouTube
function initYouTube(){
    gapi.auth2.getAuthInstance()
        .signIn({
            scope: "https://www.googleapis.com/auth/youtube"
        });

    gapi.client.setApiKey("AIzaSyBIpgj4F7hzTBjhIpY5WKMXkdvGmN6nBEo");

    gapi.client.load("https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest");
}

// da mettere in rec-js
function trim(){
     //$.get('/prova?input='+ $('#inputProva').val() +'&start='+ $('#start').val() +'&end='+ $('#end').val() +'&volume='+ $('#volume').val());
     $.get('/prova?input='+ $('#inputProva').val() +'&start='+ $('#start').val() +'&end='+ $('#end').val() +'&volume='+ $('#volume').val());
   
    console.log('/prova?input='+ $('#inputProva').val() +'&start='+ $('#start').val() +'&end='+ $('#end').val()+'&volume='+ $('#volume').val());
    
}      

var player = videojs('myVideo', {
    // video.js options
    controls: true,
    loop: true,
    fluid: true,
    width: 320,
    height: 240,
    plugins: {
        // videojs-record plugin options
        record: {
            image: false,
            audio: true,
            video: true,
            maxLength: 50,
            debug: true
        }
    }
});

function startRec(){

   // player.record().getDevice();
    player.record().start();
    
    //player.record().start();
}
function stopRec(){
    player.record().stop();
    player.record().stopDevice();
}

player.on('finishRecord', function() {

    // the recordedData object contains the stream data that
    // can be downloaded by the user, stored on server etc.
    console.log('finished recording: ', player.recordedData);
    console.log("player:",player);
    var data = player.recordedData;
    console.log("data",data);
    
    // var url = '/upload?name='+ data.name + '/';
    // var formData = new FormData();
    // formData.append('video', data, data.name);
   /* $.ajax({
        method:'POST',
        url:url,
        body:formData,
        success:function(){
            console.log("upload complete");
            window.location.href = url;
        },
        error:function(){
            console.log("error during update");
        }
    })*/
    var auth = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
   /* var metadata = {
        snippet: {
            title:'OLC', //mettere OLC nel titolo
            description: 'da comporre', //comporre descrizione in base a come hanno implementato la mappa
            tags: this.tags,
            categoryId: this.categoryId
        }
    }
    formData.append('mediaBody',metadata)
*/
    
    var title = $('#title').val();
    var latitudine = $('#latitudine').val(); //Da sostituire con OLC 
    var longitudine = $('#longitudine').val();//Come sopra
    var purpose = $('#purpose').val();
    var language = $('#language').val();
    var content = $('#content').val();
    var audience = $('#audience').val();
    var detail = $('#detail').val();

metadata = {
    kind: 'youtube#video',
    snippet: {
    title: title,
    description : latitudine +":" + longitudine +":"+language+":"+content+":"+":A"+audience+":P"+detail
    },
    status: {
    privacyStatus: 'public',
    embeddable: true
    }
}
console.log(metadata);
//variabile meta che crea un Blob facendo lo stringify di metadata 
var meta = new Blob([JSON.stringify(metadata)], { type: 'application/json' });
// Creiamo un formData che accetta in entrata solo oggetti di tipo Blob
var form = new FormData();
//Blob per il metadata
form.append('video', meta);
//Blob del video
form.append('mediaBody', data);


// $.ajax({
//     url: 'https://www.googleapis.com/upload/youtube/v3/videos?access_token=' + encodeURIComponent(auth) + '&part=snippet,status',
//     data: form,
//     cache: false,
//     contentType: false,
//     processData: false,
//     metadata:metadata,
//     method: 'POST',
//     success:function(data) {
//     alert("Il video Ã¨ stato inserito sul tuo canale Youtube!!!");                                
//     } 
//     });
});

function saveRec() {
   var title = $('#title').val();
   player.record().saveAs({'video':title+'.mp4'});
}

player.on('startRecord', function() {
    console.log('started recording!');
});




</script>
</body>
</html>